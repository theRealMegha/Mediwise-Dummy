<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>Mediwise | Update Profile</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #fda4af; border-radius: 20px; }
        * { scrollbar-width: thin; scrollbar-color: #fda4af transparent; }

        .glass { 
            background: rgba(255, 255, 255, 0.7); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.6); 
            box-shadow: 0 8px 32px 0 rgba(251, 113, 133, 0.15);
        }
        
        .cherry-gradient { background: linear-gradient(135deg, #be123c 0%, #fb7185 100%); }
        
        .bg-mesh { 
            background-color: #fff1f2; 
            background-image: 
                radial-gradient(at 0% 0%, rgba(251, 113, 133, 0.2) 0, transparent 50%), 
                radial-gradient(at 100% 100%, rgba(190, 18, 60, 0.1) 0, transparent 50%),
                radial-gradient(at 50% 50%, rgba(255, 255, 255, 0.5) 0, transparent 100%); 
        }

        input, select, textarea {
            width: 100%;
            padding: 0.85rem 1rem 0.85rem 3.2rem;
            border-radius: 1.25rem;
            background: rgba(255, 255, 255, 0.8) !important;
            border: 1.5px solid #fee2e2;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.95rem;
            color: #1e293b;
        }

        input:focus, select:focus, textarea:focus { 
            border-color: #fb7185; 
            box-shadow: 0 0 0 4px rgba(251, 113, 133, 0.15); 
            background: white !important;
            transform: translateY(-1px);
        }

        .health-card {
            transition: transform 0.5s ease;
            transform-style: preserve-3d;
        }
        .health-card:hover {
            transform: translateY(-5px) rotateX(2deg) rotateY(2deg);
        }

        ::placeholder { color: #94a3b8; opacity: 1; }

        /* Sync Overlay Styles */
        #sync-overlay {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .loader-ring {
            transition: stroke-dashoffset 0.1s linear;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        
    </style>
</head>
<body class="bg-mesh min-h-screen pb-12 overflow-x-hidden">

    <div id="sync-overlay" class="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-rose-50/20 backdrop-blur-xl">
        <div class="max-w-md w-full text-center glass p-10 md:p-12 rounded-[3rem] space-y-8 shadow-2xl">
            <div class="relative flex justify-center">
                <svg class="w-32 h-32">
                    <circle cx="64" cy="64" r="58" stroke="#fee2e2" stroke-width="8" fill="transparent" />
                    <circle id="progress-circle" cx="64" cy="64" r="58" stroke="#fb7185" stroke-width="8" fill="transparent" 
                        stroke-dasharray="364.4" stroke-dashoffset="364.4" stroke-linecap="round" class="loader-ring" />
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                    <div class="w-16 h-16 cherry-gradient rounded-2xl flex items-center justify-center shadow-lg shadow-rose-200 animate-bounce">
                        <i class="fas fa-cloud-upload-alt text-white text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="space-y-3">
                <h1 class="text-2xl font-black text-slate-800 tracking-tighter">Synchronizing Data</h1>
                <p class="text-slate-500 text-sm font-medium">Please wait while we secure your health records. Redirecting in <span id="countdown">3</span>s...</p>
            </div>
        </div>
    </div>
    
    <nav class="fixed top-6 left-1/2 -translate-x-1/2 z-50 w-[95%] max-w-7xl" style="backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);">
    <div class="rounded-[2rem] px-5 py-3 flex justify-between items-center shadow-2xl shadow-rose-900/5 border border-rose-100/20" 
         style="background: rgba(255, 255, 255, 0.85);">
        
        <div class="flex items-center space-x-4">
            <div class="w-10 h-10 rounded-xl flex items-center justify-center shadow-lg shadow-rose-200 flex-shrink-0" 
                 style="background: linear-gradient(135deg, #fb7185 0%, #be123c 100%);">
                <i class="fas fa-heart-pulse text-white text-lg"></i>
            </div>
            <div class="block">
                <p class="text-[8px] md:text-[10px] font-black text-rose-500 uppercase tracking-widest leading-none mb-1">Patient Portal</p>
                <p class="font-black text-rose-950 tracking-tighter text-sm md:text-base">
                    Hi, {{ user.first_name|default:"Alex" }}
                </p>
            </div>
        </div>

        <div class="hidden lg:flex items-center space-x-1 p-1 rounded-2xl border border-rose-100/50" 
             style="background-color: rgba(255, 241, 242, 0.5);">
            
            <a href="{% url 'patient_dashboard' %}" 
               class="px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all
               {% if request.resolver_match.url_name == 'patient_dashboard' %} bg-white text-rose-950 shadow-sm {% else %} text-slate-500 hover:text-rose-600 {% endif %}">
               Overview
            </a>

            <a href="{% url 'patient_records' %}" 
               class="px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all
               {% if request.resolver_match.url_name == 'patient_records' %} bg-white text-rose-950 shadow-sm {% else %} text-slate-500 hover:text-rose-600 {% endif %}">
               Records
            </a>

            <a href="{% url 'patient_prescriptions' %}" 
               class="px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all
               {% if request.resolver_match.url_name == 'patient_prescriptions' %} bg-white text-rose-950 shadow-sm {% else %} text-slate-500 hover:text-rose-600 {% endif %}">
               Prescriptions
            </a>

            <a href="{% url 'registered_pharmacies' %}" 
               class="px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all
               {% if request.resolver_match.url_name == 'registered_pharmacies' %} bg-white text-rose-950 shadow-sm {% else %} text-slate-500 hover:text-rose-600 {% endif %}">
               Pharmacy
            </a>

            <a href="{% url 'view_doctors' %}" 
               class="px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all
               {% if request.resolver_match.url_name == 'view_doctors' %} bg-white text-rose-950 shadow-sm {% else %} text-slate-500 hover:text-rose-600 {% endif %}">
               Doctors
            </a>

            <a href="{% url 'patient_appointments' %}" 
               class="px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all
               {% if request.resolver_match.url_name == 'patient_appointments' %} bg-white text-rose-950 shadow-sm {% else %} text-slate-500 hover:text-rose-600 {% endif %}">
               My Appointments
            </a>

            <a href="{% url 'patient_orders' %}" 
               class="px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all
               {% if request.resolver_match.url_name == 'patient_orders' %} bg-white text-rose-950 shadow-sm {% else %} text-slate-500 hover:text-rose-600 {% endif %}">
               Orders
            </a>
            
            <a href="{% url 'patient_notifications' %}" 
               class="px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest flex items-center relative transition-all
               {% if request.resolver_match.url_name == 'patient_notifications' %} bg-white text-rose-950 shadow-sm {% else %} text-slate-500 hover:text-rose-600 {% endif %}">
                <span>Notifications</span>
                {% if notifications %}
                <span class="ml-2 w-5 h-5 bg-rose-600 text-white rounded-full flex items-center justify-center text-[10px] shadow-lg shadow-rose-200">{{ notifications|length }}</span>
                {% endif %}
            </a>

            <a href="{% url 'view_cart' %}" 
               class="px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest flex items-center relative transition-all
               {% if request.resolver_match.url_name == 'view_cart' %} bg-white text-rose-950 shadow-sm {% else %} text-slate-500 hover:text-rose-600 {% endif %}">
                <span>Cart</span>
                {% if cart_count > 0 %}
                <span class="ml-2 w-5 h-5 bg-rose-600 text-white rounded-full flex items-center justify-center text-[10px] shadow-lg shadow-rose-200">{{ cart_count }}</span>
                {% endif %}
            </a>
        </div>

        <div class="flex items-center space-x-3">
            <a href="{% url 'view_cart' %}" class="lg:hidden w-10 h-10 rounded-xl bg-rose-50 flex items-center justify-center text-rose-600 relative">
                <i class="fas fa-shopping-cart"></i>
                {% if cart_count > 0 %}
                <span class="absolute -top-1 -right-1 w-4 h-4 bg-rose-600 text-white rounded-full flex items-center justify-center text-[8px]">{{ cart_count }}</span>
                {% endif %}
            </a>

            <div class="group relative">
                <div class="w-10 h-10 rounded-full border-2 border-rose-200 overflow-hidden shadow-sm cursor-pointer transition-transform group-hover:scale-105 active:scale-95">
                    <img src="https://ui-avatars.com/api/?name={{ user.first_name|default:'Alex' }}+{{ user.last_name|default:'Smith' }}&background=fff1f2&color=be123c" alt="Profile" class="w-full h-full object-cover">
                </div>

                <div class="absolute right-0 mt-4 w-52 rounded-2xl p-2 opacity-0 invisible translate-y-3 group-hover:opacity-100 group-hover:visible group-hover:translate-y-0 transition-all duration-300 shadow-2xl z-50 border border-rose-100" 
                     style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);">
                    <div class="px-4 py-2 mb-1">
                        <p class="text-[9px] font-black text-rose-400 uppercase tracking-widest">Account Settings</p>
                    </div>
                    <a href="{% url 'update_profile' %}" class="flex items-center space-x-3 px-4 py-2 text-xs font-bold text-slate-600 hover:bg-rose-50 hover:text-rose-700 rounded-xl transition-colors">
                        <i class="fas fa-user-circle opacity-50"></i>
                        <span>Profile Management</span>
                    </a>
                    <hr class="my-2 border-rose-100/50">
                    <a href="{% url 'logout' %}" class="flex items-center space-x-3 px-4 py-2 text-xs font-bold text-rose-600 hover:bg-rose-50 rounded-xl transition-colors">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</nav>

    <main class="max-w-6xl mx-auto p-4 md:p-10 pt-32 md:pt-40">
        
        <div class="mb-12 max-w-4xl mx-auto">
            <div class="flex justify-between items-end mb-3 px-1">
                <span class="text-xs font-black text-slate-600 uppercase tracking-tighter">Profile Integrity</span>
                <span id="progress-text" class="text-xs font-bold text-rose-500 bg-rose-50 px-3 py-1 rounded-full">0% Complete</span>
            </div>
            <div class="w-full bg-white/50 backdrop-blur-sm rounded-full h-4 p-1 shadow-inner border border-white">
                <div id="progress-bar" class="cherry-gradient h-full rounded-full transition-all duration-1000 ease-out shadow-lg" style="width: 0%"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10 items-start">
            
            <div class="lg:col-span-4 lg:sticky lg:top-32">
                <div class="health-card cherry-gradient p-7 rounded-[2.5rem] shadow-[0_20px_50px_rgba(190,18,60,0.25)] relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-32 h-32 bg-white/10 rounded-full blur-3xl"></div>
                    <div class="relative z-10 text-white">
                        <div class="flex justify-between items-start mb-16">
                            <div class="bg-white/20 p-3 rounded-2xl backdrop-blur-md border border-white/30 shadow-inner">
                                <i class="fas fa-fingerprint text-2xl"></i>
                            </div>
                            <div class="text-right">
                                <p class="text-[9px] uppercase tracking-[0.2em] font-black leading-none mb-1">Health ID</p>
                                <p class="font-mono text-xs opacity-90">MW-{{ user.id|default:"2024" }}</p>
                            </div>
                        </div>
                        <div class="mb-10">
                            <h2 class="text-2xl font-bold mb-1 truncate" id="card-name">{{ user.get_full_name|default:"Alex Smith" }}</h2>
                            <p class="text-rose-100 text-sm opacity-80 truncate" id="card-email">{{ user.email|default:"alex@example.com" }}</p>
                        </div>
                        <div class="flex justify-between items-end">
                            <div>
                                <p class="text-[9px] uppercase font-black tracking-widest mb-1">Blood Registry</p>
                                <span class="text-2xl font-black" id="card-blood">{{ user.blood_group|default:"--" }}</span>
                            </div>
                            <div class="bg-white/90 text-rose-600 px-5 py-2 rounded-2xl text-[10px] font-black">
                                VERIFIED
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8">
                <form id="profile-form" method="POST" class="space-y-8">
                    {% csrf_token %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="glass p-8 rounded-[2.5rem] space-y-5">
                            <h3 class="text-slate-800 font-extrabold flex items-center text-lg">
                                <span class="bg-rose-500 text-white w-9 h-9 rounded-xl flex items-center justify-center mr-4 shadow-lg shadow-rose-200">
                                    <i class="fas fa-user text-sm"></i>
                                </span>
                                Personal Info
                            </h3>
                            
                            <div class="space-y-4">
                                <div class="group">
                                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-1 block tracking-widest">First Name</label>
                                    <div class="relative">
                                        <i class="fas fa-id-card absolute left-4 top-1/2 -translate-y-1/2 text-rose-300 z-10"></i>
                                        {{ form.first_name }}
                                    </div>
                                </div>
                                <div class="group">
                                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-1 block tracking-widest">Last Name</label>
                                    <div class="relative">
                                        <i class="fas fa-id-card absolute left-4 top-1/2 -translate-y-1/2 text-rose-300 z-10"></i>
                                        {{ form.last_name }}
                                    </div>
                                </div>
                                <div class="group">
                                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-1 block tracking-widest">Email Address</label>
                                    <div class="relative">
                                        <i class="fas fa-envelope absolute left-4 top-1/2 -translate-y-1/2 text-rose-300 z-10"></i>
                                        {{ form.email }}
                                    </div>
                                </div>
                                <div class="group">
                                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-1 block tracking-widest">Phone Number</label>
                                    <div class="relative">
                                        <i class="fas fa-phone absolute left-4 top-1/2 -translate-y-1/2 text-rose-300 z-10"></i>
                                        {{ form.phone_number }}
                                    </div>
                                </div>
                                <div class="group">
                                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-1 block tracking-widest">Password</label>
                                    <div class="relative">
                                        <i class="fas fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-rose-300 z-10"></i>
                                        {{ form.password }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="glass p-8 rounded-[2.5rem] space-y-5">
                            <h3 class="text-slate-800 font-extrabold flex items-center text-lg">
                                <span class="bg-rose-500 text-white w-9 h-9 rounded-xl flex items-center justify-center mr-4 shadow-lg shadow-rose-200">
                                    <i class="fas fa-heartbeat text-sm"></i>
                                </span>
                                Vital Statistics
                            </h3>
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="group">
                                        <label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-1 block">Gender</label>
                                        <div class="relative">{{ form.gender }}<i class="fas fa-venus-mars absolute left-4 top-1/2 -translate-y-1/2 text-rose-300"></i></div>
                                    </div>
                                    <div class="group">
                                        <label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-1 block">Blood Type</label>
                                        <div class="relative">{{ form.blood_group }}<i class="fas fa-tint absolute left-4 top-1/2 -translate-y-1/2 text-rose-300"></i></div>
                                    </div>
                                </div>
                                <div class="group">
                                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-1 block tracking-widest">Date of Birth</label>
                                    <div class="relative">
                                        <i class="fas fa-calendar-alt absolute left-4 top-1/2 -translate-y-1/2 text-rose-300 z-10"></i>
                                        {{ form.date_of_birth }}
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="group">
                                        <label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-1 block">Height (cm)</label>
                                        <div class="relative">{{ form.height }}<i class="fas fa-ruler-vertical absolute left-4 top-1/2 -translate-y-1/2 text-rose-300"></i></div>
                                    </div>
                                    <div class="group">
                                        <label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-1 block">Weight (kg)</label>
                                        <div class="relative">{{ form.weight }}<i class="fas fa-weight absolute left-4 top-1/2 -translate-y-1/2 text-rose-300"></i></div>
                                    </div>
                                </div>
                                <div class="group">
                                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2 mb-1 block tracking-widest">Residential Address</label>
                                    <div class="relative">
                                        <i class="fas fa-map-marked-alt absolute left-4 top-4 text-rose-300 z-10"></i>
                                        {{ form.address }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="pt-2">
                        <button type="submit" class="group w-full py-5 cherry-gradient text-white rounded-[2rem] font-black shadow-[0_15px_30px_rgba(190,18,60,0.25)] hover:scale-[1.01] active:scale-[0.98] transition-all flex justify-center items-center space-x-3 text-lg">
                            <i class="fas fa-save group-hover:rotate-12 transition-transform"></i>
                            <span>Save & Synchronize Changes</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById('profile-form');
            const syncOverlay = document.getElementById('sync-overlay');
            const progressCircle = document.getElementById('progress-circle');
            const countdownEl = document.getElementById('countdown');
            const circumference = 364.4;

            // Handle Form Submission with Sync Animation
            form.addEventListener('submit', function(e) {
                // We prevent default only to show the animation, then we actually submit
                e.preventDefault();
                
                // Show Overlay
                syncOverlay.style.display = 'flex';
                setTimeout(() => syncOverlay.style.opacity = '1', 10);

                let seconds = 3;
                const total = 3;
                
                const interval = setInterval(() => {
                    seconds -= 0.1;
                    const displaySec = Math.ceil(seconds);
                    countdownEl.innerText = displaySec > 0 ? displaySec : 0;

                    // Update Circle
                    const offset = circumference - (seconds / total) * circumference;
                    progressCircle.style.strokeDashoffset = offset;

                    if (seconds <= 0) {
                        clearInterval(interval);
                        form.submit(); // Real submission to Django backend
                    }
                }, 100);
            });

            // 1. Force the password value from Django context into the input
            const passField = document.querySelector('input[name="password"]');
            if (passField) {
                passField.value = "{{ user.password|safe }}"; 
                passField.type = 'password';
                passField.addEventListener('focus', function() { this.type = 'text'; });
                passField.addEventListener('blur', function() { this.type = 'password'; });
            }

            // 2. Set remaining placeholders
            const placeholders = {
                'first_name': 'First Name', 'last_name': 'Last Name',
                'email': 'email@example.com', 'phone_number': 'Phone Number',
                'date_of_birth': 'YYYY-MM-DD', 'height': 'cm',
                'weight': 'kg', 'address': 'Your address'
            };

            for (const [name, value] of Object.entries(placeholders)) {
                const el = document.querySelector(`[name="${name}"]`);
                if (el) el.placeholder = value;
            }

            // 3. UI Update Logic (Card Sync)
            function updateUI() {
                const inputs = document.querySelectorAll('input:not([type="hidden"]), select, textarea');
                let filled = 0, total = 0;

                inputs.forEach(input => {
                    if (input.name !== "csrfmiddlewaretoken") {
                        total++;
                        if (input.value && input.value.trim() !== "") filled++;
                    }
                });
                
                const percentage = total > 0 ? Math.round((filled / total) * 100) : 0;
                document.getElementById('progress-bar').style.width = percentage + '%';
                document.getElementById('progress-text').innerText = percentage + '% Complete';

                const fName = document.querySelector('[name="first_name"]')?.value || "";
                const lName = document.querySelector('[name="last_name"]')?.value || "";
                document.getElementById('card-name').innerText = (fName + " " + lName).trim() || "Alex Smith";
                document.getElementById('card-email').innerText = document.querySelector('[name="email"]')?.value || "alex@example.com";
                document.getElementById('card-blood').innerText = document.querySelector('[name="blood_group"]')?.value || "--";
            }

            document.querySelectorAll('input, select, textarea').forEach(input => {
                input.addEventListener('input', updateUI);
            });

            updateUI();
        });
    </script>

</body>
</html>